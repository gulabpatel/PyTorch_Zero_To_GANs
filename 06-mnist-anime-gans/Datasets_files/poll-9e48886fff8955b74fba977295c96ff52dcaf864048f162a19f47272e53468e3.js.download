define("discourse/plugins/poll/initializers/extend-for-poll",["exports","@ember/object","discourse/lib/plugin-api","discourse/widgets/glue","discourse-common/lib/get-owner","discourse-common/utils/decorators"],function(e,g,t,b,p,c){"use strict";function l(h){var e,t,f=(0,p.getRegister)(h);h.modifyClass("controller:topic",{subscribe:function(){var l=this;this._super.apply(this,arguments),this.messageBus.subscribe("/polls/"+this.get("model.id"),function(e){var t=l.get("model.postStream").findLoadedPost(e.post_id);t&&t.set("polls",e.polls)})},unsubscribe:function(){this.messageBus.unsubscribe("/polls/*"),this._super.apply(this,arguments)}});var l,o,n,i,s,r,m=[],a=null;function u(){m.forEach(function(e){return e.queueRerender()})}h.modifyClass("model:post",(e=(0,c.observes)("polls"),l=t={_polls:null,pollsObject:null,pollsChanged:function(){var t=this,e=this.polls;e&&(this._polls=this._polls||{},e.forEach(function(e){t._polls[e.name]?t._polls[e.name].setProperties(e):t._polls[e.name]=g.default.create(e)}),this.set("pollsObject",this._polls),u())}},o="pollsChanged",n=[e],i=Object.getOwnPropertyDescriptor(t,"pollsChanged"),s=t,r={},Object.keys(i).forEach(function(e){r[e]=i[e]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=n.slice().reverse().reduce(function(e,t){return t(l,o,e)||e},r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(l,o,r),r=null),t)),h.includePostAttributes("polls","polls_votes"),h.decorateCooked(function(e,t){var p,c,d,l=$(".poll",e);l.length&&t&&(p=t.getModel(),h.preventCloak(p.id),p.pollsChanged(),c=p.pollsObject||{},d=p.polls_votes||{},a=a||setInterval(u,3e4),l.each(function(e,t){var l,o,n,i=$(t),s=i.data("poll-name"),r=c[s],a=d[s]||[],u=i.parent(".expanded-quote").data("post-id");!u||(l=p.quoted[u])&&(p=g.default.create(l),r=g.default.create(l.polls.find(function(e){return e.name===s})),a=(a=l.polls_votes||{})[s]||[]),r&&(o={id:s+"-"+p.id,post:p,poll:r,vote:a,groupableUserFields:(h.container.lookup("site-settings:main").poll_groupable_user_fields||"").split("|").filter(Boolean)},(n=new b.default("discourse-poll",f,o)).appendTo(t),m.push(n))}))},{onlyStream:!0,id:"discourse-poll"}),h.cleanupStream(function(){a&&(clearInterval(a),a=null),m.forEach(function(e){return e.cleanUp()}),m=[]})}Object.defineProperty(e,"__esModule",{value:!0}),e.default={name:"extend-for-poll",initialize:function(){(0,t.withPluginApi)("0.8.7",l)}}}),define("discourse/plugins/poll/initializers/add-poll-ui-builder",["exports","discourse/lib/plugin-api","discourse/lib/show-modal","discourse-common/utils/decorators"],function(e,t,u,p){"use strict";function l(e){var t,l,o,n,i,s,r,a;e.modifyClass("controller:composer",(t=(0,p.default)("siteSettings.poll_enabled","siteSettings.poll_minimum_trust_level_to_create","model.topic.pm_with_non_human_user"),o=l={canBuildPoll:function(e,t,l){return e&&(l||this.currentUser&&(this.currentUser.staff||this.currentUser.trust_level>=t))},actions:{showPollBuilder:function(){(0,u.default)("poll-ui-builder").set("toolbarEvent",this.toolbarEvent)}}},n="canBuildPoll",i=[t],s=Object.getOwnPropertyDescriptor(l,"canBuildPoll"),r=l,a={},Object.keys(s).forEach(function(e){a[e]=s[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce(function(e,t){return t(o,n,e)||e},a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(o,n,a),a=null),l)),e.addToolbarPopupMenuOptionsCallback(function(){return{action:"showPollBuilder",icon:"chart-bar",label:"poll.ui_builder.title",condition:"canBuildPoll"}})}Object.defineProperty(e,"__esModule",{value:!0}),e.default={name:"add-poll-ui-builder",initialize:function(){(0,t.withPluginApi)("0.8.7",l)}}}),define("discourse/plugins/poll/lib/even-round",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e){for(var t=e.map(function(e){return e%1}),l=Math.ceil(t.reduce(function(e,t){return e+t})),o=0,n=t.length;o<l&&o<n;o++){for(var i=0,s=0,r=0;r<t.length;r++)t[r]>i&&(i=t[s=r]);if(++e[s],t[s]=0,100===e.map(function(e){return Math.floor(e)}).reduce(function(e,t){return e+t}))break}return e.map(function(e){return Math.floor(e)})}}),define("discourse/plugins/poll/lib/discourse-markdown/poll",["exports","I18n"],function(e,m){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.setup=function(e){e.whiteList(["div.poll","div.poll-info","div.poll-container","div.poll-buttons","div[data-*]","span.info-number","span.info-text","span.info-label","a.button.cast-votes","a.button.toggle-results","li[data-*]"]),function(e){e.registerOptions(function(e,t){e.features.poll=!!t.poll_enabled,e.pollMaximumOptions=t.poll_maximum_options}),e.registerPlugin(function(e){e.block.bbcode.ruler.push("poll",t)})}(e)};var g="data-poll-",b=["close","max","min","name","order","public","results","chartType","groups","status","step","type"];function v(e,t,l){var o=e.indexOf(t),n=e[o].level;for(e.splice.apply(e,[o,1].concat(function(e){if(Array.isArray(e)){for(var t=0,l=Array(e.length);t<e.length;t++)l[t]=e[t];return l}return Array.from(e)}(l))),l[0].map=t.map;o<e.length;o++){var i=e[o].nesting;i<0&&n--,e[o].level=n,0<i&&n++}}function _(e,t){e.push("text","",0).content="[/"+t+"]"}var t={tag:"poll",before:function(e,t,l){var o=e.push("text","",0);o.content=l,o.bbcode_attrs=t.attrs,o.bbcode_type="poll_open"},after:function(e,t,l){var o=function(e,t){for(var l=e.length-1,o=[],n=[];e[l]!==t;l--){if(0===l)return;var i=e[l];if(0===i.level&&"ol"!==i.tag&&"ul"!==i.tag)return;if(1===i.level&&1===i.nesting){if("li"!==i.tag)return;o.push([i,n.reverse().join(" ")])}1===i.level&&1===i.nesting&&"li"===i.tag?n=[]:"text"!==i.type&&"inline"!==i.type||n.push(i.content)}return o.reverse()}(e.tokens,t);if(!o)return _(e,l);var n=t.bbcode_attrs,i=[["class","poll"]];n.status||i.push([g+"status","open"]),b.forEach(function(e){n[e]&&i.push([g+e,n[e]])}),n.name||i.push([g+"name","poll"]);var s=parseInt(n.min,10),r=parseInt(n.max,10),a=parseInt(n.step,10);a<1&&(a=1);var u=[],p=new e.Token("poll_open","div",1);if(p.block=!0,p.attrs=i,u.push(p),(p=new e.Token("poll_open","div",1)).block=!0,u.push(p),(p=new e.Token("poll_open","div",1)).attrs=[["class","poll-container"]],u.push(p),"number"===n.type){if(isNaN(s)&&(s=1),isNaN(r)&&(r=e.md.options.discourse.pollMaximumOptions),isNaN(a)&&(a=1),0<o.length)return _(e,l);p=new e.Token("bullet_list_open","ul",1),u.push(p);for(var c=s;c<=r;c+=a)p=new e.Token("list_item_open","li",1),o.push([p,String(c)]),u.push(p),(p=new e.Token("text","",0)).content=String(c),u.push(p),p=new e.Token("list_item_close","li",-1),u.push(p);p=new e.Token("bullet_item_close","",-1),u.push(p)}for(var d=0;d<o.length;d++){p=o[d][0];var h=o[d][1];p.attrs=p.attrs||[];var f=function(e){for(var t=0;t<e.length;t++)e[t]=function(e){for(var t="",l=0;l<4;l++)t+=w[e>>8*l+4&15]+w[e>>8*l&15];return t}(e[t]);return e.join("")}(function(e){/[\x80-\xFF]/.test(e)&&(e=unescape(encodeURI(e)));var t,l=e.length,o=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=e.length;t+=64)y(o,function(e){var t,l=[];for(t=0;t<64;t+=4)l[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return l}(e.substring(t-64,t)));e=e.substring(t-64);var n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<e.length;t++)n[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(n[t>>2]|=128<<(t%4<<3),55<t)for(y(o,n),t=0;t<16;t++)n[t]=0;return n[14]=8*l,y(o,n),o}(JSON.stringify([h])));p.attrs.push([g+"option-id",f])}v(e.tokens,t,u),e.level=e.tokens[e.tokens.length-1].level,e.push("poll_close","div",-1),(p=e.push("poll_open","div",1)).attrs=[["class","poll-info"]],e.push("paragraph_open","p",1),(p=e.push("span_open","span",1)).block=!1,p.attrs=[["class","info-number"]],(p=e.push("text","",0)).content="0",e.push("span_close","span",-1),(p=e.push("span_open","span",1)).block=!1,p.attrs=[["class","info-label"]],(p=e.push("text","",0)).content=m.default.t("poll.voters",{count:0}),e.push("span_close","span",-1),e.push("paragraph_close","p",-1),e.push("poll_close","div",-1),e.push("poll_close","div",-1),e.push("poll_close","div",-1)}};function y(e,t){var l=s(l=e[0],i=e[1],n=e[2],o=e[3],t[0],7,-680876936),o=s(o,l,i,n,t[1],12,-389564586),n=s(n,o,l,i,t[2],17,606105819),i=s(i,n,o,l,t[3],22,-1044525330);l=s(l,i,n,o,t[4],7,-176418897),o=s(o,l,i,n,t[5],12,1200080426),n=s(n,o,l,i,t[6],17,-1473231341),i=s(i,n,o,l,t[7],22,-45705983),l=s(l,i,n,o,t[8],7,1770035416),o=s(o,l,i,n,t[9],12,-1958414417),n=s(n,o,l,i,t[10],17,-42063),i=s(i,n,o,l,t[11],22,-1990404162),l=s(l,i,n,o,t[12],7,1804603682),o=s(o,l,i,n,t[13],12,-40341101),n=s(n,o,l,i,t[14],17,-1502002290),l=a(l,i=s(i,n,o,l,t[15],22,1236535329),n,o,t[1],5,-165796510),o=a(o,l,i,n,t[6],9,-1069501632),n=a(n,o,l,i,t[11],14,643717713),i=a(i,n,o,l,t[0],20,-373897302),l=a(l,i,n,o,t[5],5,-701558691),o=a(o,l,i,n,t[10],9,38016083),n=a(n,o,l,i,t[15],14,-660478335),i=a(i,n,o,l,t[4],20,-405537848),l=a(l,i,n,o,t[9],5,568446438),o=a(o,l,i,n,t[14],9,-1019803690),n=a(n,o,l,i,t[3],14,-187363961),i=a(i,n,o,l,t[8],20,1163531501),l=a(l,i,n,o,t[13],5,-1444681467),o=a(o,l,i,n,t[2],9,-51403784),n=a(n,o,l,i,t[7],14,1735328473),l=u(l,i=a(i,n,o,l,t[12],20,-1926607734),n,o,t[5],4,-378558),o=u(o,l,i,n,t[8],11,-2022574463),n=u(n,o,l,i,t[11],16,1839030562),i=u(i,n,o,l,t[14],23,-35309556),l=u(l,i,n,o,t[1],4,-1530992060),o=u(o,l,i,n,t[4],11,1272893353),n=u(n,o,l,i,t[7],16,-155497632),i=u(i,n,o,l,t[10],23,-1094730640),l=u(l,i,n,o,t[13],4,681279174),o=u(o,l,i,n,t[0],11,-358537222),n=u(n,o,l,i,t[3],16,-722521979),i=u(i,n,o,l,t[6],23,76029189),l=u(l,i,n,o,t[9],4,-640364487),o=u(o,l,i,n,t[12],11,-421815835),n=u(n,o,l,i,t[15],16,530742520),l=p(l,i=u(i,n,o,l,t[2],23,-995338651),n,o,t[0],6,-198630844),o=p(o,l,i,n,t[7],10,1126891415),n=p(n,o,l,i,t[14],15,-1416354905),i=p(i,n,o,l,t[5],21,-57434055),l=p(l,i,n,o,t[12],6,1700485571),o=p(o,l,i,n,t[3],10,-1894986606),n=p(n,o,l,i,t[10],15,-1051523),i=p(i,n,o,l,t[1],21,-2054922799),l=p(l,i,n,o,t[8],6,1873313359),o=p(o,l,i,n,t[15],10,-30611744),n=p(n,o,l,i,t[6],15,-1560198380),i=p(i,n,o,l,t[13],21,1309151649),l=p(l,i,n,o,t[4],6,-145523070),o=p(o,l,i,n,t[11],10,-1120210379),n=p(n,o,l,i,t[2],15,718787259),i=p(i,n,o,l,t[9],21,-343485551),e[0]=c(l,e[0]),e[1]=c(i,e[1]),e[2]=c(n,e[2]),e[3]=c(o,e[3])}function r(e,t,l,o,n,i){return t=c(c(t,e),c(o,i)),c(t<<n|t>>>32-n,l)}function s(e,t,l,o,n,i,s){return r(t&l|~t&o,e,t,n,i,s)}function a(e,t,l,o,n,i,s){return r(t&o|l&~o,e,t,n,i,s)}function u(e,t,l,o,n,i,s){return r(t^l^o,e,t,n,i,s)}function p(e,t,l,o,n,i,s){return r(l^(t|~o),e,t,n,i,s)}var w="0123456789abcdef".split("");function c(e,t){return e+t&4294967295}}),define("discourse/plugins/poll/lib/chart-colors",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getColors=function(e,t){var l=void 0;switch(t=t||"cool"){case"cool":l={0:[255,255,255],25:[220,237,200],50:[66,179,213],75:[26,39,62],100:[0,0,0]};break;case"warm":l={0:[255,255,255],25:[254,235,101],50:[228,82,27],75:[77,52,47],100:[0,0,0]}}for(var o=Object.keys(l),n=[],i=void 0,s=void 0,r=0;r<e;r++){i=(r+1)*(100/(e+1));for(var a=void 0,u=s=s||0;u<o.length;u++){if(!o[u+1]){a=u-1;break}if(i>=o[u]&&i<o[u+1]){a=u;break}}for(var p=(i-o[a])/(o[a+1]-o[a]),c=[],d=0;d<3;d++)c.push(Math.round(l[o[a]][d]-(l[o[a]][d]-l[o[a+1]][d])*p));n.push("rgb("+c.toString()+")"),s=a}return n}}),define("discourse/plugins/poll/controllers/poll-ui-builder",["exports","I18n","@ember/controller","@ember/object","discourse-common/utils/decorators"],function(e,i,t,o,l){"use strict";function n(l,o,e,t,n){var i={};return Object.keys(t).forEach(function(e){i[e]=t[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=e.slice().reverse().reduce(function(e,t){return t(l,o,e)||e},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(l,o,i),i=null),i}var s,r,a,u,p,c,d,h,f,m,g,b,v,y,w,O,x,P,M;Object.defineProperty(e,"__esModule",{value:!0}),e.PIE_CHART_TYPE=e.BAR_CHART_TYPE=void 0;e.BAR_CHART_TYPE="bar",e.PIE_CHART_TYPE="pie";e.default=t.default.extend((s=(0,l.default)("regularPollType","numberPollType","multiplePollType"),r=(0,l.default)("chartType","pollType","numberPollType"),a=(0,l.default)("alwaysPollResult","votePollResult","closedPollResult","staffPollResult"),u=(0,l.default)("site.groups"),p=(0,l.default)("pollType","regularPollType"),c=(0,l.default)("pollType","pollOptionsCount","multiplePollType"),d=(0,l.default)("pollType","numberPollType"),h=(0,l.default)("isRegular"),f=(0,l.default)("pollOptions"),m=(0,l.observes)("pollType","pollOptionsCount"),g=(0,l.default)("isRegular","isMultiple","isNumber","pollOptionsCount"),b=(0,l.default)("isRegular","isMultiple","isNumber","pollOptionsCount","pollMin","pollStep"),v=(0,l.default)("isNumber","pollMax"),y=(0,l.default)("isNumber","showMinMax","pollType","pollResult","publicPoll","pollOptions","pollMin","pollMax","pollStep","pollGroups","autoClose","chartType","date","time"),w=(0,l.default)("pollOptionsCount","isRegular","isMultiple","isNumber","pollMin","pollMax"),O=(0,l.default)("pollMin","pollMax"),x=(0,l.default)("pollStep"),P=(0,l.default)("disableInsert"),n(M={regularPollType:"regular",numberPollType:"number",multiplePollType:"multiple",alwaysPollResult:"always",votePollResult:"on_vote",closedPollResult:"on_close",staffPollResult:"staff_only",pollChartTypes:[{name:i.default.t("poll.ui_builder.poll_chart_type.bar"),value:"bar"},{name:i.default.t("poll.ui_builder.poll_chart_type.pie"),value:"pie"}],pollType:null,pollResult:null,init:function(){this._super.apply(this,arguments),this._setupPoll()},pollTypes:function(e,t,l){return[{name:i.default.t("poll.ui_builder.poll_type.regular"),value:e},{name:i.default.t("poll.ui_builder.poll_type.number"),value:t},{name:i.default.t("poll.ui_builder.poll_type.multiple"),value:l}]},isPie:function(e,t,l){return t!==l&&"pie"===e},pollResults:function(e,t,l,o){var n=[{name:i.default.t("poll.ui_builder.poll_result.always"),value:e},{name:i.default.t("poll.ui_builder.poll_result.vote"),value:t},{name:i.default.t("poll.ui_builder.poll_result.closed"),value:l}];return this.get("currentUser.staff")&&n.push({name:i.default.t("poll.ui_builder.poll_result.staff"),value:o}),n},siteGroups:function(e){return e.map(function(e){if(0!==e.id)return{name:e.name}}).filter(Boolean)},isRegular:function(e,t){return e===t},isMultiple:function(e,t,l){return e===l&&0<t},isNumber:function(e,t){return e===t},showMinMax:function(e){return!e},pollOptionsCount:function(e){if(0===e.length)return 0;var t=0;return e.split("\n").forEach(function(e){0!==e.length&&(t+=1)}),t},_setPollMax:function(){var e=this.isMultiple,t=this.isNumber;(e||t)&&(e?this.set("pollMax",this.pollOptionsCount):t&&this.set("pollMax",this.siteSettings.poll_maximum_options))},pollMinOptions:function(e,t,l,o){if(!e)return t?this._comboboxOptions(1,o+1):l?this._comboboxOptions(1,this.siteSettings.poll_maximum_options+1):void 0},pollMaxOptions:function(e,t,l,o,n,i){if(!e){var s=parseInt(n,10)||1;if(t)return this._comboboxOptions(s+1,o+1);if(l){var r=parseInt(i,10);return r<1&&(r=1),this._comboboxOptions(s+1,s+this.siteSettings.poll_maximum_options*r)}}},pollStepOptions:function(e,t){if(e)return this._comboboxOptions(1,(parseInt(t,10)||1)+1)},pollOutput:function(e,t,l,o,n,i,s,r,a,u,p,c,d,h){var f="[poll",m="",g=this.toolbarEvent.getText().match(/\[poll(\s+name=[^\s\]]+)*.*\]/gim);g&&(f+=" name=poll"+(g.length+1));var b,v=a;return v<1&&(v=1),l&&(f+=" type="+l),o&&(f+=" results="+o),s&&t&&(f+=" min="+s),r&&(f+=" max="+r),e&&(f+=" step="+v),n&&(f+=" public=true"),c&&"number"!==l&&(f+=" chartType="+c),u&&0<u.length&&(f+=" groups="+u),!p||(b=moment(d+" "+h,"YYYY-MM-DD HH:mm").toISOString())&&(f+=" close="+b),m+=(f+="]")+"\n",0<i.length&&!e&&i.split("\n").forEach(function(e){0!==e.length&&(m+="* "+e+"\n")}),m+="[/poll]\n"},disableInsert:function(e,t,l,o,n,i){return t&&e<1||l&&e<n&&i<=n||!o&&e<1},minMaxValueValidation:function(e,t){var l={ok:!0};return t<=e&&(l={failed:!0,reason:i.default.t("poll.ui_builder.help.invalid_values")}),o.default.create(l)},minStepValueValidation:function(e){var t={ok:!0};return e<1&&(t={failed:!0,reason:i.default.t("poll.ui_builder.help.min_step_value")}),o.default.create(t)},minNumOfOptionsValidation:function(e){var t={ok:!0};return e&&(t={failed:!0,reason:i.default.t("poll.ui_builder.help.options_count")}),o.default.create(t)},_comboboxOptions:function(e,t){return _.range(e,t).map(function(e){return{value:e,name:e}})},_setupPoll:function(){this.setProperties({pollType:this.get("pollTypes.firstObject.value"),publicPoll:!1,pollOptions:"",pollMin:1,pollMax:null,pollStep:1,autoClose:!1,chartType:"bar",pollResult:this.alwaysPollResult,pollGroups:null,date:moment().add(1,"day").format("YYYY-MM-DD"),time:moment().add(1,"hour").format("HH:mm")})},actions:{insertPoll:function(){this.toolbarEvent.addText(this.pollOutput),this.send("closeModal"),this._setupPoll()}}},"pollTypes",[s],Object.getOwnPropertyDescriptor(M,"pollTypes"),M),n(M,"isPie",[r],Object.getOwnPropertyDescriptor(M,"isPie"),M),n(M,"pollResults",[a],Object.getOwnPropertyDescriptor(M,"pollResults"),M),n(M,"siteGroups",[u],Object.getOwnPropertyDescriptor(M,"siteGroups"),M),n(M,"isRegular",[p],Object.getOwnPropertyDescriptor(M,"isRegular"),M),n(M,"isMultiple",[c],Object.getOwnPropertyDescriptor(M,"isMultiple"),M),n(M,"isNumber",[d],Object.getOwnPropertyDescriptor(M,"isNumber"),M),n(M,"showMinMax",[h],Object.getOwnPropertyDescriptor(M,"showMinMax"),M),n(M,"pollOptionsCount",[f],Object.getOwnPropertyDescriptor(M,"pollOptionsCount"),M),n(M,"_setPollMax",[m],Object.getOwnPropertyDescriptor(M,"_setPollMax"),M),n(M,"pollMinOptions",[g],Object.getOwnPropertyDescriptor(M,"pollMinOptions"),M),n(M,"pollMaxOptions",[b],Object.getOwnPropertyDescriptor(M,"pollMaxOptions"),M),n(M,"pollStepOptions",[v],Object.getOwnPropertyDescriptor(M,"pollStepOptions"),M),n(M,"pollOutput",[y],Object.getOwnPropertyDescriptor(M,"pollOutput"),M),n(M,"disableInsert",[w],Object.getOwnPropertyDescriptor(M,"disableInsert"),M),n(M,"minMaxValueValidation",[O],Object.getOwnPropertyDescriptor(M,"minMaxValueValidation"),M),n(M,"minStepValueValidation",[x],Object.getOwnPropertyDescriptor(M,"minStepValueValidation"),M),n(M,"minNumOfOptionsValidation",[P],Object.getOwnPropertyDescriptor(M,"minNumOfOptionsValidation"),M),M))}),define("discourse/plugins/poll/controllers/poll-breakdown",["exports","I18n","@ember/controller","@ember/object","@ember/string","discourse/lib/ajax","discourse/lib/ajax-error","discourse/lib/load-script","discourse/mixins/modal-functionality","discourse-common/utils/decorators"],function(e,l,t,o,n,i,s,r,a,u){"use strict";function p(l,o,e,t,n){var i={};return Object.keys(t).forEach(function(e){i[e]=t[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=e.slice().reverse().reduce(function(e,t){return t(l,o,e)||e},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(l,o,i),i=null),i}var c,d,h;Object.defineProperty(e,"__esModule",{value:!0}),e.default=t.default.extend(a.default,(c=(0,u.default)("model.groupableUserFields"),d=(0,u.default)("model.poll.options"),p(h={model:null,charts:null,groupedBy:null,highlightedOption:null,displayMode:"percentage",groupableUserFields:function(e){return e.map(function(e){var t=e.split("_").filter(Boolean);return 1<t.length&&(t[0]=(0,n.classify)(t[0])),{id:e,label:t.join(" ")}})},totalVotes:function(e){return e.reduce(function(e,t){return e+t.votes},0)},onShow:function(){var e=this;this.set("charts",null),this.set("displayMode","percentage"),this.set("groupedBy",this.model.groupableUserFields[0]),(0,r.default)("/javascripts/Chart.min.js").then(function(){return(0,r.default)("/javascripts/chartjs-plugin-datalabels.min.js")}).then(function(){window.Chart.plugins.unregister(window.ChartDataLabels),e.fetchGroupedPollData()})},fetchGroupedPollData:function(){var t=this;return(0,i.ajax)("/polls/grouped_poll_results.json",{data:{post_id:this.model.post.id,poll_name:this.model.poll.name,user_field_name:this.groupedBy}}).catch(function(e){e?(0,s.popupAjaxError)(e):bootbox.alert(l.default.t("poll.error_while_fetching_voters"))}).then(function(e){t.isDestroying||t.isDestroyed||t.set("charts",e.grouped_results)})},setGrouping:function(e){this.set("groupedBy",e),this.fetchGroupedPollData()},onSelectPanel:function(e){this.set("displayMode",e.id)}},"groupableUserFields",[c],Object.getOwnPropertyDescriptor(h,"groupableUserFields"),h),p(h,"totalVotes",[d],Object.getOwnPropertyDescriptor(h,"totalVotes"),h),p(h,"setGrouping",[o.action],Object.getOwnPropertyDescriptor(h,"setGrouping"),h),p(h,"onSelectPanel",[o.action],Object.getOwnPropertyDescriptor(h,"onSelectPanel"),h),h))}),define("discourse/plugins/poll/widgets/discourse-poll",["exports","I18n","virtual-dom","discourse/lib/ajax","discourse/lib/ajax-error","discourse/lib/formatter","discourse/lib/load-script","discourse/lib/round","discourse/lib/show-modal","discourse/widgets/post","discourse/widgets/raw-html","discourse/widgets/widget","discourse-common/lib/icon-library","discourse/plugins/poll/controllers/poll-ui-builder","discourse/plugins/poll/lib/chart-colors","discourse/plugins/poll/lib/even-round"],function(e,y,c,s,r,w,t,a,l,o,O,n,i,u,p,d){"use strict";function h(e){var t=$("<span>"+e.html+"</span>");return t.find(".discourse-local-date").each(function(e,t){$(t).applyLocalDates()}),new O.default({html:"<span>"+t.html()+"</span>"})}function x(e){return new O.default({html:'<span class="info-text">'+e+"</span>"})}function f(e){return(0,s.ajax)("/polls/voters.json",{data:e}).catch(function(e){e?(0,r.popupAjaxError)(e):bootbox.alert(y.default.t("poll.error_while_fetching_voters"))})}function m(e,t){var l=t&&t.groups&&t.groups.split(",").map(function(e){return e.toLowerCase()});if(!l)return 1;var o=e&&e.groups&&e.groups.map(function(e){return e.name.toLowerCase()});return o&&l.some(function(e){return o.includes(e)})}Object.defineProperty(e,"__esModule",{value:!0}),(0,n.createWidget)("discourse-poll-option",{tagName:"li",buildAttributes:function(e){return{"data-poll-option-id":e.option.id}},html:function(e){var t=[],l=e.option,o=e.vote.includes(l.id);return e.isMultiple?t.push((0,i.iconNode)(o?"far-check-square":"far-square")):t.push((0,i.iconNode)(o?"circle":"far-circle")),t.push(" "),t.push(h(l)),t},click:function(e){0===$(e.target).closest("a").length&&this.sendWidgetAction("toggleOption",this.attrs.option)}}),(0,n.createWidget)("discourse-poll-load-more",{tagName:"div.poll-voters-toggle-expand",buildKey:function(e){return"load-more-"+e.optionId},defaultState:function(){return{loading:!1}},html:function(e,t){return t.loading?(0,c.h)("div.spinner.small"):(0,c.h)("a",(0,i.iconNode)("chevron-down"))},click:function(){var e=this.state;if(!e.loading)return e.loading=!0,this.sendWidgetAction("loadMore").finally(function(){return e.loading=!1})}}),(0,n.createWidget)("discourse-poll-voters",{tagName:"ul.poll-voters-list",buildKey:function(e){return"poll-voters-"+e.optionId},defaultState:function(){return{loaded:"new",voters:[],page:1}},fetchVoters:function(){var o=this,n=this.attrs,i=this.state;if("loading"!==i.loaded)return i.loaded="loading",f({post_id:n.postId,poll_name:n.pollName,option_id:n.optionId,page:i.page}).then(function(e){i.loaded="loaded",i.page+=1;var t="number"===n.pollType?e.voters:e.voters[n.optionId],l=new Set(i.voters.map(function(e){return e.username}));t.forEach(function(e){l.has(e.username)||(l.add(e.username),i.voters.push(e))}),o.scheduleRerender()})},loadMore:function(){return this.fetchVoters()},html:function(e,t){e.voters&&"new"===t.loaded&&(t.voters=e.voters);var l=t.voters.map(function(e){return(0,c.h)("li",[(0,o.avatarFor)("tiny",{username:e.username,template:e.avatar_template})," "])});return t.voters.length<e.totalVotes&&l.push(this.attach("discourse-poll-load-more",e)),(0,c.h)("div.poll-voters",l)}}),(0,n.createWidget)("discourse-poll-standard-results",{tagName:"ul.results",buildKey:function(e){return"poll-standard-results-"+e.id},defaultState:function(){return{loaded:!1}},fetchVoters:function(){var t=this,e=this.attrs,l=this.state;return f({post_id:e.post.id,poll_name:e.poll.get("name")}).then(function(e){l.voters=e.voters,t.scheduleRerender()})},html:function(i,s){var r=this,a=i.poll,e=a.get("options");if(e){var t=a.get("voters"),u=a.get("public"),l=_.clone(e).sort(function(e,t){return!(e.votes<t.votes)&&(e.votes!==t.votes||e.html<t.html)?-1:1});u&&!s.loaded&&(s.voters=a.get("preloaded_voters"),s.loaded=!0);var o=0===t?Array(l.length).fill(0):l.map(function(e){return 100*e.votes/t}),p=i.isMultiple?o.map(Math.floor):(0,d.default)(o);return l.map(function(e,t){var l=[],o=p[t].toString(),n=(i.vote||[]).includes(e.id);return l.push((0,c.h)("div.option",(0,c.h)("p",[(0,c.h)("span.percentage",o+"%"),h(e)]))),l.push((0,c.h)("div.bar-back",(0,c.h)("div.bar",{attributes:{style:"width:"+o+"%"}}))),u&&l.push(r.attach("discourse-poll-voters",{postId:i.post.id,optionId:e.id,pollName:a.get("name"),totalVotes:e.votes,voters:s.voters&&s.voters[e.id]||[]})),(0,c.h)("li",{className:n?"chosen":""},l)})}}}),(0,n.createWidget)("discourse-poll-number-results",{buildKey:function(e){return"poll-number-results-"+e.id},defaultState:function(){return{loaded:!1}},fetchVoters:function(){var t=this,e=this.attrs,l=this.state;return f({post_id:e.post.id,poll_name:e.poll.get("name")}).then(function(e){l.voters=e.voters,t.scheduleRerender()})},html:function(e,t){var l=e.poll,o=l.get("options").reduce(function(e,t){return e+parseInt(t.html,10)*parseInt(t.votes,10)},0),n=l.get("voters"),i=0===n?0:(0,a.default)(o/n,-2),s=y.default.t("poll.average_rating",{average:i}),r=[(0,c.h)("div.poll-results-number-rating",new O.default({html:"<span>"+s+"</span>"}))];return l.get("public")&&(t.loaded||(t.voters=l.get("preloaded_voters"),t.loaded=!0),r.push(this.attach("discourse-poll-voters",{totalVotes:l.get("voters"),voters:t.voters||[],postId:e.post.id,pollName:l.get("name"),pollType:l.get("type")}))),r}}),(0,n.createWidget)("discourse-poll-container",{tagName:"div.poll-container",html:function(t){var l=this,e=t.poll,o=e.get("options");if(t.showResults){var n="number"===e.get("type")?"number":"standard",i="number"==n||t.poll.chart_type!==u.PIE_CHART_TYPE?"discourse-poll-"+n+"-results":"discourse-poll-pie-chart";return this.attach(i,t)}if(o){var s=[];return m(this.currentUser,e)||s.push((0,c.h)("div.alert.alert-danger",y.default.t("poll.results.groups.title",{groups:e.groups}))),s.push((0,c.h)("ul",o.map(function(e){return l.attach("discourse-poll-option",{option:e,isMultiple:t.isMultiple,vote:t.vote})}))),s}}}),(0,n.createWidget)("discourse-poll-info",{tagName:"div.poll-info",multipleHelpText:function(e,t,l){if(0<t)if(e===t){if(1<e)return y.default.t("poll.multiple.help.x_options",{count:e})}else{if(1<e)return t<l?y.default.t("poll.multiple.help.between_min_and_max_options",{min:e,max:t}):y.default.t("poll.multiple.help.at_least_min_options",{count:e});if(t<=l)return y.default.t("poll.multiple.help.up_to_max_options",{count:t})}},html:function(e){var t,l,o=e.poll,n=o.get("voters"),i=[(0,c.h)("p",[(0,c.h)("span.info-number",n.toString()),(0,c.h)("span.info-label",y.default.t("poll.voters",{count:n}))])];return e.isMultiple&&(e.showResults||e.isClosed?(t=o.get("options").reduce(function(e,t){return e+parseInt(t.votes,10)},0),i.push((0,c.h)("p",[(0,c.h)("span.info-number",t.toString()),(0,c.h)("span.info-label",y.default.t("poll.total_votes",{count:t}))]))):(l=this.multipleHelpText(e.min,e.max,o.get("options.length")))&&i.push(x(l))),e.isClosed||e.showResults||!o.public||"staff_only"===o.results||i.push(x(y.default.t("poll.public.title"))),i}}),(0,n.createWidget)("discourse-poll-pie-canvas",{tagName:"canvas.poll-results-canvas",init:function(o){(0,t.default)("/javascripts/Chart.min.js").then(function(){var e=function(e,o){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},l="aspectRatio"in t?t.aspectRatio:2.2,n=o.map(function(e){return t=e,(new DOMParser).parseFromString(t,"text/html").body.textContent||"";var t});return{type:u.PIE_CHART_TYPE,data:{datasets:[{data:e,backgroundColor:(0,p.getColors)(e.length)}],labels:n},options:{responsive:!0,aspectRatio:l,animation:{duration:0},legend:{display:!1},legendCallback:function(e){for(var t="",l=0;l<o.length;l++)t+='<div class="legend"><span class="swatch" style="background-color:\n            '+e.data.datasets[0].backgroundColor[l]+'"></span>'+o[l]+"</div>";return t}}}}(o.poll.options.mapBy("votes"),o.poll.options.mapBy("html")),t=document.getElementById("poll-results-chart-"+o.id),l=new Chart(t.getContext("2d"),e);document.getElementById("poll-results-legend-"+o.id).innerHTML=l.generateLegend()})},buildAttributes:function(e){return{id:"poll-results-chart-"+e.id}}}),(0,n.createWidget)("discourse-poll-pie-chart",{tagName:"div.poll-results-chart",html:function(e){var t,l,o,n=[];if(!e.showResults)return t=e.id,(l=document.querySelector("#poll-results-chart-"+t))&&l.parentNode.removeChild(l),n;e.groupableUserFields.length&&(o=this.attach("button",{className:"btn-default poll-show-breakdown",label:"poll.group-results.label",title:"poll.group-results.title",icon:"far-eye",action:"showBreakdown"}),n.push(o));var i=this.attach("discourse-poll-pie-canvas",e);return n.push(i),n.push((0,c.h)("div#poll-results-legend-"+e.id+".pie-chart-legends")),n}}),(0,n.createWidget)("discourse-poll-buttons",{tagName:"div.poll-buttons",html:function(e){var t,l,o,n,i,s,r=[],a=e.poll,u=e.post,p=u.get("topic.archived"),c=e.isClosed,d="staff_only"===a.results,h=this.currentUser&&this.currentUser.staff,f=this.currentUser&&this.currentUser.admin,m=this.currentUser&&u.user_id===this.currentUser.id,g=this.siteSettings.data_explorer_enabled,b=!d&&(c||p),v=this.siteSettings.poll_export_data_explorer_query_id;return e.isMultiple&&!b&&(t=!e.canCastVotes,r.push(this.attach("button",{className:"cast-votes "+(t?"btn-default":"btn-primary"),label:"poll.cast-votes.label",title:"poll.cast-votes.title",disabled:t,action:"castVotes"})),r.push(" ")),e.showResults||b?r.push(this.attach("button",{className:"btn-default toggle-results",label:"poll.hide-results.label",title:"poll.hide-results.title",icon:"far-eye-slash",disabled:b,action:"toggleResults"})):"on_vote"!==a.get("results")||e.hasVoted||m?"on_close"!==a.get("results")||c?"staff_only"!==a.results||h?r.push(this.attach("button",{className:"btn-default toggle-results",label:"poll.show-results.label",title:"poll.show-results.title",icon:"far-eye",disabled:0===a.get("voters"),action:"toggleResults"})):r.push(x(y.default.t("poll.results.staff.title"))):r.push(x(y.default.t("poll.results.closed.title"))):r.push(x(y.default.t("poll.results.vote.title"))),f&&g&&0<a.voters&&v&&r.push(this.attach("button",{className:"btn btn-default export-results",label:"poll.export-results.label",title:"poll.export-results.title",icon:"download",disabled:0===a.voters,action:"exportResults"})),!a.get("close")||(l=moment(a.get("close"))).isValid()&&(o=l.format("LLL"),i=void 0,i=e.isAutomaticallyClosed?(n=(0,w.relativeAge)(l.toDate(),{addAgo:!0}),y.default.t("poll.automatic_close.age",{age:n})):(s=moment().to(l,!0),y.default.t("poll.automatic_close.closes_in",{timeLeft:s})),r.push(new O.default({html:'<span class="info-text" title="'+o+'">'+i+"</span>"}))),!this.currentUser||this.currentUser.get("id")!==u.get("user_id")&&!h||p||(c?e.isAutomaticallyClosed||r.push(this.attach("button",{className:"btn-default toggle-status",label:"poll.open.label",title:"poll.open.title",icon:"unlock-alt",action:"toggleStatus"})):r.push(this.attach("button",{className:"toggle-status btn-danger",label:"poll.close.label",title:"poll.close.title",icon:"lock",action:"toggleStatus"}))),r}}),e.default=(0,n.createWidget)("discourse-poll",{tagName:"div",buildKey:function(e){return"poll-"+e.id},buildAttributes:function(e){var t="poll";return e.poll.chart_type===u.PIE_CHART_TYPE&&(t+=" pie"),{class:t,"data-poll-name":e.poll.get("name"),"data-poll-type":e.poll.get("type")}},defaultState:function(e){var t=e.post,l=e.poll,o="staff_only"===e.poll.results;return{loading:!1,showResults:t.get("topic.archived")&&!o||this.isClosed()&&!o||"on_close"!==l.results&&this.hasVoted()&&!o}},html:function(e,t){var l="staff_only"===e.poll.results,o=t.showResults||e.post.get("topic.archived")&&!l||this.isClosed()&&!l,n=jQuery.extend({},e,{canCastVotes:this.canCastVotes(),hasVoted:this.hasVoted(),isAutomaticallyClosed:this.isAutomaticallyClosed(),isClosed:this.isClosed(),isMultiple:this.isMultiple(),max:this.max(),min:this.min(),showResults:o});return(0,c.h)("div",[this.attach("discourse-poll-container",n),this.attach("discourse-poll-info",n),this.attach("discourse-poll-buttons",n)])},min:function(){var e=parseInt(this.attrs.poll.get("min"),10);return(isNaN(e)||e<0)&&(e=0),e},max:function(){var e=parseInt(this.attrs.poll.get("max"),10),t=this.attrs.poll.get("options.length");return(isNaN(e)||t<e)&&(e=t),e},isAutomaticallyClosed:function(){var e=this.attrs.poll;return e.get("close")&&moment.utc(e.get("close"))<=moment()},isClosed:function(){return"closed"===this.attrs.poll.get("status")||this.isAutomaticallyClosed()},isMultiple:function(){return"multiple"===this.attrs.poll.get("type")},hasVoted:function(){var e=this.attrs.vote;return e&&0<e.length},canCastVotes:function(){var e=this.state,t=this.attrs;if(this.isClosed()||e.showResults||e.loading)return!1;var l=t.vote.length;return this.isMultiple()?l>=this.min()&&l<=this.max():0<l},toggleStatus:function(){var l=this,o=this.state,e=this.attrs,n=e.post,i=e.poll;this.isAutomaticallyClosed()||bootbox.confirm(y.default.t(this.isClosed()?"poll.open.confirm":"poll.close.confirm"),y.default.t("no_value"),y.default.t("yes_value"),function(e){var t;e&&(o.loading=!0,t=l.isClosed()?"open":"closed",(0,s.ajax)("/polls/toggle_status",{type:"PUT",data:{post_id:n.get("id"),poll_name:i.get("name"),status:t}}).then(function(){i.set("status",t),"on_close"===i.get("results")&&(o.showResults="closed"==t),l.scheduleRerender()}).catch(function(e){e?(0,r.popupAjaxError)(e):bootbox.alert(y.default.t("poll.error_while_toggling_status"))}).finally(function(){o.loading=!1}))})},toggleResults:function(){this.state.showResults=!this.state.showResults},exportResults:function(){var o=this.attrs,e=this.siteSettings.poll_export_data_explorer_query_id;(0,s.ajax)("/admin/plugins/explorer/queries/"+e+"/run.csv",{type:"POST",data:{params:JSON.stringify({poll_name:o.poll.name,post_id:o.post.id.toString()}),explain:!1,limit:1e6,download:1}}).then(function(e){var t=document.createElement("a"),l=new Blob([e],{type:"text/csv;charset=utf-8;"});t.href=URL.createObjectURL(l),t.setAttribute("download","poll-export-"+o.poll.name+"-"+o.post.id+".csv"),t.click(),t.remove()}).catch(function(e){e?(0,r.popupAjaxError)(e):bootbox.alert(y.default.t("poll.error_while_exporting_results"))})},showLogin:function(){this.register.lookup("route:application").send("showLogin")},_toggleOption:function(e){var t=this.attrs.vote,l=t.indexOf(e.id);-1!==l?t.splice(l,1):t.push(e.id)},toggleOption:function(e){var t=this,l=this.attrs;if(!this.isClosed()){if(!this.currentUser)return this.showLogin();if(m(this.currentUser,this.attrs.poll)){var o=l.vote;return this.isMultiple()||(o.length=0),this._toggleOption(e),this.isMultiple()?void 0:this.castVotes().catch(function(){return t._toggleOption(e)})}}},castVotes:function(){var l=this;if(this.canCastVotes()){if(!this.currentUser)return this.showLogin();var o=this.attrs,n=this.state;return n.loading=!0,(0,s.ajax)("/polls/vote",{type:"PUT",data:{post_id:o.post.id,poll_name:o.poll.get("name"),options:o.vote}}).then(function(e){var t=e.poll;o.poll.setProperties(t),"on_close"!==o.poll.get("results")&&(n.showResults=!0),"staff_only"===o.poll.results&&(l.currentUser&&l.currentUser.get("staff")?n.showResults=!0:n.showResults=!1)}).catch(function(e){e?(0,r.popupAjaxError)(e):bootbox.alert(y.default.t("poll.error_while_casting_votes"))}).finally(function(){n.loading=!1})}},showBreakdown:function(){(0,l.default)("poll-breakdown",{model:this.attrs,panels:[{id:"percentage",title:"poll.breakdown.percentage"},{id:"count",title:"poll.breakdown.count"}]})}})}),Ember.TEMPLATES["javascripts/modal/poll-ui-builder"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[4,"d-modal-body",null,[["title","class"],["poll.ui_builder.title","poll-ui-builder"]],{"statements":[[0,"  "],[7,"form",true],[10,"class","poll-ui-builder-form form-horizontal"],[8],[0,"\\n    "],[7,"div",true],[10,"class","options"],[8],[0,"\\n      "],[7,"div",true],[10,"class","input-group poll-select"],[8],[0,"\\n        "],[7,"label",true],[10,"class","input-group-label"],[8],[1,[28,"i18n",["poll.ui_builder.poll_type.label"],null],false],[9],[0,"\\n        "],[1,[28,"combo-box",null,[["content","value","valueProperty","class","onChange"],[[24,["pollTypes"]],[24,["pollType"]],"value","poll-type",[28,"action",[[23,0,[]],[28,"mut",[[24,["pollType"]]],null]],null]]]],false],[0,"\\n      "],[9],[0,"\\n\\n      "],[7,"div",true],[10,"class","input-group poll-select"],[8],[0,"\\n        "],[7,"label",true],[10,"class","input-group-label"],[8],[1,[28,"i18n",["poll.ui_builder.poll_result.label"],null],false],[9],[0,"\\n        "],[1,[28,"combo-box",null,[["content","value","class","valueProperty","onChange"],[[24,["pollResults"]],[24,["pollResult"]],"poll-result","value",[28,"action",[[23,0,[]],[28,"mut",[[24,["pollResult"]]],null]],null]]]],false],[0,"\\n      "],[9],[0,"\\n\\n      "],[7,"div",true],[10,"class","input-group poll-select"],[8],[0,"\\n        "],[7,"label",true],[10,"class","input-group-label"],[8],[1,[28,"i18n",["poll.ui_builder.poll_groups.label"],null],false],[9],[0,"\\n        "],[1,[28,"group-chooser",null,[["content","value","onChange","labelProperty","valueProperty"],[[24,["siteGroups"]],[24,["pollGroups"]],[28,"action",[[23,0,[]],[28,"mut",[[24,["pollGroups"]]],null]],null],"name","name"]]],false],[0,"\\n      "],[9],[0,"\\n\\n"],[4,"unless",[[24,["isNumber"]]],null,{"statements":[[0,"        "],[7,"div",true],[10,"class","input-group poll-select"],[8],[0,"\\n          "],[7,"label",true],[10,"class","input-group-label"],[8],[1,[28,"i18n",["poll.ui_builder.poll_chart_type.label"],null],false],[9],[0,"\\n          "],[1,[28,"combo-box",null,[["class","content","value","valueProperty","onChange"],["poll-chart-type",[24,["pollChartTypes"]],[24,["chartType"]],"value",[28,"action",[[23,0,[]],[28,"mut",[[24,["chartType"]]],null]],null]]]],false],[0,"\\n        "],[9],[0,"\\n"]],"parameters":[]},null],[0,"\\n"],[4,"if",[[24,["showMinMax"]]],null,{"statements":[[0,"        "],[7,"div",true],[10,"class","input-group poll-number"],[8],[0,"\\n          "],[7,"label",true],[10,"class","input-group-label"],[8],[1,[28,"i18n",["poll.ui_builder.poll_config.min"],null],false],[9],[0,"\\n          "],[1,[28,"input",null,[["type","value","valueProperty","class"],["number",[24,["pollMin"]],"value","poll-options-min"]]],false],[0,"\\n        "],[9],[0,"\\n        "],[1,[28,"input-tip",null,[["validation"],[[24,["minMaxValueValidation"]]]]],false],[0,"\\n\\n        "],[7,"div",true],[10,"class","input-group poll-number"],[8],[0,"\\n          "],[7,"label",true],[10,"class","input-group-label"],[8],[1,[28,"i18n",["poll.ui_builder.poll_config.max"],null],false],[9],[0,"\\n          "],[1,[28,"input",null,[["type","value","valueProperty","class"],["number",[24,["pollMax"]],"value","poll-options-max"]]],false],[0,"\\n        "],[9],[0,"\\n\\n"],[4,"if",[[24,["isNumber"]]],null,{"statements":[[0,"          "],[7,"div",true],[10,"class","input-group poll-number"],[8],[0,"\\n            "],[7,"label",true],[10,"class","input-group-label"],[8],[1,[28,"i18n",["poll.ui_builder.poll_config.step"],null],false],[9],[0,"\\n            "],[1,[28,"input",null,[["type","value","valueProperty","min","class"],["number",[24,["pollStep"]],"value","1","poll-options-step"]]],false],[0,"\\n          "],[9],[0,"\\n          "],[1,[28,"input-tip",null,[["validation"],[[24,["minStepValueValidation"]]]]],false],[0,"\\n"]],"parameters":[]},null]],"parameters":[]},null],[0,"\\n"],[4,"unless",[[24,["isNumber"]]],null,{"statements":[[0,"        "],[7,"div",true],[10,"class","input-group poll-textarea"],[8],[0,"\\n          "],[7,"label",true],[8],[1,[28,"i18n",["poll.ui_builder.poll_options.label"],null],false],[9],[0,"\\n          "],[1,[28,"textarea",null,[["value","autocomplete"],[[24,["pollOptions"]],"discourse"]]],false],[0,"\\n        "],[9],[0,"\\n        "],[1,[28,"input-tip",null,[["validation"],[[24,["minNumOfOptionsValidation"]]]]],false],[0,"\\n"]],"parameters":[]},null],[0,"\\n"],[4,"unless",[[24,["isPie"]]],null,{"statements":[[0,"        "],[7,"div",true],[10,"class","input-group poll-checkbox"],[8],[0,"\\n          "],[7,"label",true],[8],[0,"\\n            "],[1,[28,"input",null,[["type","checked"],["checkbox",[24,["publicPoll"]]]]],false],[0,"\\n            "],[1,[28,"i18n",["poll.ui_builder.poll_public.label"],null],false],[0,"\\n          "],[9],[0,"\\n        "],[9],[0,"\\n"]],"parameters":[]},null],[0,"\\n      "],[7,"div",true],[10,"class","input-group poll-checkbox"],[8],[0,"\\n        "],[7,"label",true],[8],[0,"\\n          "],[1,[28,"input",null,[["type","checked"],["checkbox",[24,["autoClose"]]]]],false],[0,"\\n          "],[1,[28,"i18n",["poll.ui_builder.automatic_close.label"],null],false],[0,"\\n        "],[9],[0,"\\n      "],[9],[0,"\\n\\n"],[4,"if",[[24,["autoClose"]]],null,{"statements":[[0,"        "],[7,"div",true],[10,"class","input-group poll-date"],[8],[0,"\\n          "],[1,[28,"date-picker-future",null,[["value","containerId"],[[24,["date"]],"date-container"]]],false],[0,"\\n          "],[1,[28,"input",null,[["type","value"],["time",[24,["time"]]]]],false],[0,"\\n        "],[9],[0,"\\n\\n        "],[7,"div",true],[10,"class","input-group poll-date"],[8],[0,"\\n          "],[7,"div",true],[10,"id","date-container"],[8],[9],[0,"\\n        "],[9],[0,"\\n"]],"parameters":[]},null],[0,"    "],[9],[0,"\\n\\n    "],[7,"div",true],[10,"class","d-editor-preview"],[8],[0,"\\n      "],[1,[28,"cook-text",[[23,0,["pollOutput"]]],null],false],[0,"\\n    "],[9],[0,"\\n  "],[9],[0,"\\n"]],"parameters":[]},null],[0,"\\n"],[7,"div",true],[10,"class","modal-footer"],[8],[0,"\\n  "],[1,[28,"d-button",null,[["action","icon","class","label","disabled"],[[28,"action",[[23,0,[]],"insertPoll"],null],"chart-bar","btn-primary","poll.ui_builder.insert",[24,["disableInsert"]]]]],false],[0,"\\n"],[9],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/modal/poll-ui-builder"}}),Ember.TEMPLATES["javascripts/modal/poll-breakdown"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["chart","option","index"],"statements":[[4,"d-modal-body",null,[["title"],["poll.breakdown.title"]],{"statements":[[0,"  "],[7,"div",true],[10,"class","poll-breakdown-sidebar"],[8],[0,"\\n"],[0,"    "],[7,"p",true],[10,"class","poll-breakdown-title"],[8],[1,[23,0,["model","post","topic","title"]],false],[9],[0,"\\n\\n    "],[7,"div",true],[10,"class","poll-breakdown-total-votes"],[8],[1,[28,"i18n",["poll.breakdown.votes"],[["count"],[[23,0,["model","poll","voters"]]]]],false],[9],[0,"\\n\\n    "],[7,"ul",true],[10,"class","poll-breakdown-options"],[8],[0,"\\n"],[4,"each",[[23,0,["model","poll","options"]]],null,{"statements":[[0,"        "],[1,[28,"poll-breakdown-option",null,[["option","index","totalVotes","optionsCount","displayMode","highlightedOption","onMouseOver","onMouseOut"],[[23,2,[]],[23,3,[]],[23,0,["totalVotes"]],[23,0,["model","poll","options","length"]],[23,0,["displayMode"]],[23,0,["highlightedOption"]],[28,"fn",[[28,"mut",[[23,0,["highlightedOption"]]],null],[23,3,[]]],null],[28,"fn",[[28,"mut",[[23,0,["highlightedOption"]]],null],null],null]]]],false],[0,"\\n"]],"parameters":[2,3]},null],[0,"    "],[9],[0,"\\n  "],[9],[0,"\\n\\n  "],[7,"div",true],[10,"class","poll-breakdown-body"],[8],[0,"\\n    "],[7,"div",true],[10,"class","poll-breakdown-body-header"],[8],[0,"\\n      "],[7,"label",true],[10,"class","poll-breakdown-body-header-label"],[8],[1,[28,"i18n",["poll.breakdown.breakdown"],null],false],[9],[0,"\\n\\n      "],[1,[28,"combo-box",null,[["content","value","nameProperty","class","onChange"],[[23,0,["groupableUserFields"]],[23,0,["groupedBy"]],"label","poll-breakdown-dropdown",[28,"action",[[23,0,[]],[23,0,["setGrouping"]]],null]]]],false],[0,"\\n    "],[9],[0,"\\n\\n    "],[7,"div",true],[10,"class","poll-breakdown-charts"],[8],[0,"\\n"],[4,"each",[[23,0,["charts"]]],null,{"statements":[[0,"        "],[1,[28,"poll-breakdown-chart",null,[["group","options","displayMode","highlightedOption","setHighlightedOption"],[[28,"get",[[23,1,[]],"group"],null],[28,"get",[[23,1,[]],"options"],null],[23,0,["displayMode"]],[23,0,["highlightedOption"]],[28,"fn",[[28,"mut",[[23,0,["highlightedOption"]]],null]],null]]]],false],[0,"\\n"]],"parameters":[1]},null],[0,"    "],[9],[0,"\\n  "],[9],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/modal/poll-breakdown"}}),Ember.TEMPLATES["javascripts/components/poll-breakdown-chart"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["@group"],"statements":[[7,"label",true],[10,"class","poll-breakdown-chart-label"],[8],[1,[23,1,[]],false],[9],[0,"\\n"],[7,"canvas",true],[10,"class","poll-breakdown-chart-chart"],[8],[9],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/poll-breakdown-chart"}}),Ember.TEMPLATES["javascripts/components/poll-breakdown-option"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["@option","@onMouseOver","@onMouseOut"],"statements":[[7,"li",false],[12,"class","poll-breakdown-option"],[12,"style",[23,0,["colorBackgroundStyle"]]],[3,"on",["mouseover",[23,2,[]]]],[3,"on",["mouseout",[23,3,[]]]],[8],[0,"\\n  "],[7,"span",true],[10,"class","poll-breakdown-option-color"],[11,"style",[23,0,["colorPreviewStyle"]]],[8],[9],[0,"\\n\\n  "],[7,"span",true],[10,"class","poll-breakdown-option-count"],[8],[0,"\\n"],[4,"if",[[24,["showPercentage"]]],null,{"statements":[[0,"      "],[1,[23,0,["percent"]],false],[0,"%\\n"]],"parameters":[]},{"statements":[[0,"      "],[1,[23,1,["votes"]],false],[0,"\\n"]],"parameters":[]}],[0,"  "],[9],[0,"\\n  "],[7,"span",true],[10,"class","poll-breakdown-option-text"],[8],[1,[23,1,["html"]],true],[9],[0,"\\n"],[9],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/poll-breakdown-option"}}),define("discourse/plugins/poll/components/poll-breakdown-option",["exports","I18n","@ember/component","@ember/object","@ember/object/computed","@ember/template","discourse/lib/computed","discourse-common/utils/decorators","discourse/plugins/poll/lib/chart-colors"],function(e,l,t,o,n,i,s,r,a){"use strict";function u(l,o,e,t,n){var i={};return Object.keys(t).forEach(function(e){i[e]=t[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=e.slice().reverse().reduce(function(e,t){return t(l,o,e)||e},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(l,o,i),i=null),i}var p,c,d,h,f;Object.defineProperty(e,"__esModule",{value:!0}),e.default=t.default.extend((p=(0,r.default)("option.votes","totalVotes"),c=(0,r.default)("optionsCount"),d=(0,r.default)("highlighted"),h=(0,r.default)("highlighted","optionColors","index"),u(f={option:null,index:null,totalVotes:null,optionsCount:null,displayMode:null,highlightedOption:null,onMouseOver:null,onMouseOut:null,tagName:"",highlighted:(0,s.propertyEqual)("highlightedOption","index"),showPercentage:(0,n.equal)("displayMode","percentage"),percent:function(e,t){return l.default.toNumber(e/t*100,{precision:1})},optionColors:function(e){return(0,a.getColors)(e)},colorBackgroundStyle:function(e){if(e)return(0,i.htmlSafe)("background: rgba(0, 0, 0, 0.1);")},colorPreviewStyle:function(e,t,l){var o=e?window.Chart.helpers.getHoverColor(t[l]):t[l];return(0,i.htmlSafe)("background: "+o+";")},onHover:function(e){e?this.onMouseOver():this.onMouseOut()}},"percent",[p],Object.getOwnPropertyDescriptor(f,"percent"),f),u(f,"optionColors",[c],Object.getOwnPropertyDescriptor(f,"optionColors"),f),u(f,"colorBackgroundStyle",[d],Object.getOwnPropertyDescriptor(f,"colorBackgroundStyle"),f),u(f,"colorPreviewStyle",[h],Object.getOwnPropertyDescriptor(f,"colorPreviewStyle"),f),u(f,"onHover",[o.action],Object.getOwnPropertyDescriptor(f,"onHover"),f),f))}),define("discourse/plugins/poll/components/poll-breakdown-chart",["exports","I18n","@ember/component","@ember/object/computed","@ember/template","discourse/plugins/poll/controllers/poll-ui-builder","discourse/plugins/poll/lib/chart-colors","discourse-common/utils/decorators"],function(e,r,t,l,o,a,u,n){"use strict";function i(l,o,e,t,n){var i={};return Object.keys(t).forEach(function(e){i[e]=t[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=e.slice().reverse().reduce(function(e,t){return t(l,o,e)||e},i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(l,o,i),i=null),i}var s,p,c;Object.defineProperty(e,"__esModule",{value:!0}),e.default=t.default.extend((s=(0,n.default)("optionColors","index"),p=(0,n.default)("data","displayMode"),i(c={group:null,options:null,displayMode:null,highlightedOption:null,setHighlightedOption:null,classNames:"poll-breakdown-chart-container",_optionToSlice:null,_previousHighlightedSliceIndex:null,_previousDisplayMode:null,data:(0,l.mapBy)("options","votes"),init:function(){this._super.apply(this,arguments),this._optionToSlice={}},didInsertElement:function(){this._super.apply(this,arguments);var e=this.element.querySelector("canvas");this._chart=new window.Chart(e.getContext("2d"),this.chartConfig)},didReceiveAttrs:function(){this._super.apply(this,arguments),this._chart&&(this._updateDisplayMode(),this._updateHighlight())},willDestroy:function(){this._super.apply(this,arguments),this._chart&&this._chart.destroy()},colorStyle:function(e,t){return(0,o.htmlSafe)("background: "+e[t]+";")},chartConfig:function(l,t){var n=this,o=[],i=0;this._optionToSlice={},l.forEach(function(e,t){0<e&&(o.push(e),n._optionToSlice[t]=i++)});var s=o.reduce(function(e,t){return e+t},0),e=(0,u.getColors)(l.length).filter(function(e,t){return 0<l[t]});return{type:a.PIE_CHART_TYPE,plugins:[window.ChartDataLabels],data:{datasets:[{data:o,backgroundColor:e,hoverBorderColor:"#fff"}]},options:{plugins:{datalabels:{color:"#333",backgroundColor:"rgba(255, 255, 255, 0.5)",borderRadius:2,font:{family:getComputedStyle(document.body).fontFamily,size:16},padding:{top:2,right:6,bottom:2,left:6},formatter:function(e){return"percentage"!==t?e:r.default.toNumber(e/s*100,{precision:1})+"%"}}},responsive:!0,aspectRatio:1.1,animation:{duration:0},tooltips:!1,onHover:function(e,t){var l,o;t.length?(l=t[0]._index,o=Object.keys(n._optionToSlice).find(function(e){return n._optionToSlice[e]===l}),t.length=0,n.setHighlightedOption(Number(o))):n.setHighlightedOption(null)}}}},_updateDisplayMode:function(){var e;this.displayMode!==this._previousDisplayMode&&(e=this.chartConfig,this._chart.data.datasets=e.data.datasets,this._chart.options=e.options,this._chart.update(),this._previousDisplayMode=this.displayMode)},_updateHighlight:function(){var e,t,l,o=this._chart.getDatasetMeta(0);null!==this._previousHighlightedSliceIndex&&(e=o.data[this._previousHighlightedSliceIndex],o.controller.removeHoverStyle(e),this._chart.draw()),null!==this.highlightedOption&&void 0!==(t=this._optionToSlice[this.highlightedOption])?(l=o.data[t],this._previousHighlightedSliceIndex=t,o.controller.setHoverStyle(l),this._chart.draw()):this._previousHighlightedSliceIndex=null}},"colorStyle",[s],Object.getOwnPropertyDescriptor(c,"colorStyle"),c),i(c,"chartConfig",[p],Object.getOwnPropertyDescriptor(c,"chartConfig"),c),c))});
//# sourceMappingURL=/assets/plugins/poll-9e48886fff8955b74fba977295c96ff52dcaf864048f162a19f47272e53468e3.js.map