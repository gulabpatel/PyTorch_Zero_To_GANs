define("discourse/plugins/discourse-presence/discourse/lib/presence",["exports","@ember/object","@ember/runloop","discourse/lib/ajax","discourse-common/utils/decorators"],function(e,a,t,n,s){"use strict";var r,i;Object.defineProperty(e,"__esModule",{value:!0}),e.COMPOSER_TYPE=e.TOPIC_TYPE=e.CLOSED=e.EDITING=e.REPLYING=e.KEEP_ALIVE_DURATION_SECONDS=void 0;e.KEEP_ALIVE_DURATION_SECONDS=10,e.REPLYING="replying";var c,o,l,u,p,d,m=e.EDITING="editing",h=(e.CLOSED="closed",e.TOPIC_TYPE="topic",e.COMPOSER_TYPE="composer",a.default.extend((r=(0,s.default)("topicId"),c=i={users:null,editingUsers:null,subscribers:null,topicId:null,currentUser:null,messageBus:null,siteSettings:null,init:function(){this._super.apply(this,arguments),this.setProperties({users:[],editingUsers:[],subscribers:new Set})},subscribe:function(e){var r=this;0===this.subscribers.size&&this.messageBus.subscribe(this.channel,function(e){var s=e.user,t=e.state;if(r.get("currentUser.id")!==s.id)switch(t){case"replying":r._appendUser(r.users,s);break;case m:r._appendUser(r.editingUsers,s,{post_id:parseInt(e.post_id,10)});break;case"closed":r._removeUser(s)}},0),this.subscribers.add(e)},unsubscribe:function(e){this.subscribers.delete(e);var s=0===this.subscribers.size;return s&&(this.messageBus.unsubscribe(this.channel),this._stopTimer(),this.setProperties({users:[],editingUsers:[]})),s},channel:function(e){return"/presence/"+e},publish:function(e,s,t,r){if(!this.get("currentUser.hide_profile_and_presence")){var i={state:e,topic_id:this.topicId};return s&&(i.is_whisper=!0),t&&e===m&&(i.post_id=t),r&&(i.staff_only=!0),(0,n.ajax)("/presence/publish",{type:"POST",data:i})}},_removeUser:function(t){[this.users,this.editingUsers].forEach(function(e){var s=e.findBy("id",t.id);s&&e.removeObject(s)})},_cleanUpUsers:function(){return[this.users,this.editingUsers].forEach(function(e){var s=[];e.forEach(function(e){e.last_seen<=Date.now()-12e3&&s.push(e)}),e.removeObjects(s)}),0===this.users.length&&0===this.editingUsers.length},_appendUser:function(e,s,t){var r=this,i=void 0,n=0;e.forEach(function(e){e.id===s.id&&(i=e),t&&t.post_id&&e.post_id!==t.post_id||n++});var c,o=t||{};o.last_seen=Date.now(),i?i.setProperties(o):(c=this.get("siteSettings.presence_max_users_shown"),n<c&&e.pushObject(a.default.create(Object.assign(s,o)))),this._startTimer(function(){r._cleanUpUsers()})},_scheduleTimer:function(e){var s=this;return(0,t.later)(this,function(){e()||s.set("_timer",s._scheduleTimer(e))},2e3)},_stopTimer:function(){(0,t.cancel)(this._timer)},_startTimer:function(e){this._timer||this.set("_timer",this._scheduleTimer(e))}},o="channel",l=[r],u=Object.getOwnPropertyDescriptor(i,"channel"),p=i,d={},Object.keys(u).forEach(function(e){d[e]=u[e]}),d.enumerable=!!d.enumerable,d.configurable=!!d.configurable,("value"in d||d.initializer)&&(d.writable=!0),d=l.slice().reverse().reduce(function(e,s){return s(c,o,e)||e},d),p&&void 0!==d.initializer&&(d.value=d.initializer?d.initializer.call(p):void 0,d.initializer=void 0),void 0===d.initializer&&(Object.defineProperty(c,o,d),d=null),i)));e.default=h}),define("discourse/plugins/discourse-presence/discourse/services/presence-manager",["exports","@ember/service","discourse/plugins/discourse-presence/discourse/lib/presence"],function(e,s,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var t=s.default.extend({presences:null,init:function(){this._super.apply(this,arguments),this.setProperties({presences:{}})},subscribe:function(e,s){e&&this._getPresence(e).subscribe(s)},unsubscribe:function(e,s){e&&this._getPresence(e).unsubscribe(s)&&delete this.presences[e]},users:function(e){return e?this._getPresence(e).users:[]},editingUsers:function(e){return e?this._getPresence(e).editingUsers:[]},publish:function(e,s,t,r,i){if(e)return this._getPresence(e).publish(s,t,r,i)},cleanUpPresence:function(s){var t=this;Object.keys(this.presences).forEach(function(e){t.publish(e,r.CLOSED),t.unsubscribe(e,s)})},_getPresence:function(e){return this.presences[e]||(this.presences[e]=r.default.create({messageBus:this.messageBus,siteSettings:this.siteSettings,currentUser:this.currentUser,topicId:e})),this.presences[e]}});e.default=t}),define("discourse/plugins/discourse-presence/discourse/templates/connectors/topic-above-footer-buttons/presence",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default={shouldRender:function(e,s){return s.siteSettings.presence_enabled}}}),Ember.TEMPLATES["javascripts/connectors/topic-above-footer-buttons/presence"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[28,"topic-presence-display",null,[["topic"],[[24,["model"]]]]],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/connectors/topic-above-footer-buttons/presence"}}),define("discourse/plugins/discourse-presence/discourse/templates/connectors/composer-fields/presence",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default={shouldRender:function(e,s){return s.siteSettings.presence_enabled}}}),Ember.TEMPLATES["javascripts/connectors/composer-fields/presence"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[28,"composer-presence-display",null,[["model"],[[24,["model"]]]]],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/connectors/composer-fields/presence"}}),Ember.TEMPLATES["javascripts/components/composer-presence-display"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["user"],"statements":[[4,"if",[[24,["shouldDisplay"]]],null,{"statements":[[0,"  "],[7,"div",true],[10,"class","presence-users"],[8],[0,"\\n    "],[7,"div",true],[10,"class","presence-avatars"],[8],[0,"\\n"],[4,"each",[[24,["presenceUsers"]]],null,{"statements":[[0,"        "],[1,[28,"avatar",[[23,1,[]]],[["avatarTemplatePath","usernamePath","imageSize"],["avatar_template","username","small"]]],false],[0,"\\n"]],"parameters":[1]},null],[0,"    "],[9],[0,"\\n    "],[7,"span",true],[10,"class","presence-text"],[8],[0,"\\n      "],[7,"span",true],[10,"class","description"],[8],[0,"\\n"],[4,"if",[[24,["isReply"]]],null,{"statements":[[1,[28,"i18n",["presence.replying"],null],false]],"parameters":[]},{"statements":[[1,[28,"i18n",["presence.editing"],null],false]],"parameters":[]}],[0,"      "],[9],[9],[7,"span",true],[10,"class","wave"],[8],[0,"\\n      "],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[0,"\\n    "],[9],[0,"\\n  "],[9],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/composer-presence-display"}}),Ember.TEMPLATES["javascripts/components/topic-presence-display"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["user"],"statements":[[4,"if",[[24,["shouldDisplay"]]],null,{"statements":[[0,"  "],[7,"div",true],[10,"class","presence-users"],[8],[0,"\\n    "],[7,"div",true],[10,"class","presence-avatars"],[8],[0,"\\n"],[4,"each",[[24,["users"]]],null,{"statements":[[0,"        "],[1,[28,"avatar",[[23,1,[]]],[["avatarTemplatePath","usernamePath","imageSize"],["avatar_template","username","small"]]],false],[0,"\\n"]],"parameters":[1]},null],[0,"    "],[9],[0,"\\n    "],[7,"span",true],[10,"class","presence-text"],[8],[0,"\\n      "],[7,"span",true],[10,"class","description"],[8],[1,[28,"i18n",["presence.replying_to_topic"],[["count"],[[24,["users","length"]]]]],false],[9],[7,"span",true],[10,"class","wave"],[8],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[9],[0,"\\n    "],[9],[0,"\\n  "],[9],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/topic-presence-display"}}),define("discourse/plugins/discourse-presence/discourse/components/composer-presence-display",["exports","@ember/component","@ember/runloop","@ember/object/computed","@ember/service","discourse-common/utils/decorators","discourse/plugins/discourse-presence/discourse/lib/presence","discourse/models/composer"],function(e,s,t,r,i,n,c,o){"use strict";function a(t,r,e,s,i){var n={};return Object.keys(s).forEach(function(e){n[e]=s[e]}),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=e.slice().reverse().reduce(function(e,s){return s(t,r,e)||e},n),i&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(i):void 0,n.initializer=void 0),void 0===n.initializer&&(Object.defineProperty(t,r,n),n=null),n}var l,u,p,d,m,h,b,f,g;Object.defineProperty(e,"__esModule",{value:!0}),e.default=s.default.extend((l=(0,n.default)("model.topic.id"),u=(0,n.default)("model.topic.id"),p=(0,n.on)("didInsertElement"),d=(0,n.default)("model.post.id","editingUsers.@each.last_seen","users.@each.last_seen","model.action"),m=(0,n.observes)("model.reply","model.title"),h=(0,n.observes)("model.whisper"),b=(0,n.observes)("model.action","model.topic.id"),f=(0,n.on)("willDestroyElement"),a(g={presenceManager:(0,i.inject)(),users:function(e){return this.presenceManager.users(e)},editingUsers:function(e){return this.presenceManager.editingUsers(e)},isReply:(0,r.equal)("model.action",o.REPLY),subscribe:function(){this.presenceManager.subscribe(this.get("model.topic.id"),c.COMPOSER_TYPE)},presenceUsers:function(e,s,t,r){return r===o.EDIT?s.filterBy("post_id",e):r===o.REPLY?t:[]},shouldDisplay:(0,r.gt)("presenceUsers.length",0),typing:function(){(0,t.throttle)(this,this._typing,1e3*c.KEEP_ALIVE_DURATION_SECONDS)},_typing:function(){var e,s=this.get("model.action");s!==o.REPLY&&s!==o.EDIT||!this.get("model.composerOpened")||(e={topicId:this.get("model.topic.id"),state:s===o.EDIT?c.EDITING:c.REPLYING,whisper:this.get("model.whisper"),postId:this.get("model.post.id"),presenceStaffOnly:this.get("model._presenceStaffOnly")},this._prevPublishData=e,this._throttle=this.presenceManager.publish(e.topicId,e.state,e.whisper,e.postId,e.presenceStaffOnly))},cancelThrottle:function(){this._cancelThrottle()},composerState:function(){this._prevPublishData&&(this.presenceManager.publish(this._prevPublishData.topicId,c.CLOSED,this._prevPublishData.whisper,this._prevPublishData.postId),this._prevPublishData=null)},closeComposer:function(){this._cancelThrottle(),this._prevPublishData=null,this.presenceManager.cleanUpPresence(c.COMPOSER_TYPE)},_cancelThrottle:function(){this._throttle&&((0,t.cancel)(this._throttle),this._throttle=null)}},"users",[l],Object.getOwnPropertyDescriptor(g,"users"),g),a(g,"editingUsers",[u],Object.getOwnPropertyDescriptor(g,"editingUsers"),g),a(g,"subscribe",[p],Object.getOwnPropertyDescriptor(g,"subscribe"),g),a(g,"presenceUsers",[d],Object.getOwnPropertyDescriptor(g,"presenceUsers"),g),a(g,"typing",[m],Object.getOwnPropertyDescriptor(g,"typing"),g),a(g,"cancelThrottle",[h],Object.getOwnPropertyDescriptor(g,"cancelThrottle"),g),a(g,"composerState",[b],Object.getOwnPropertyDescriptor(g,"composerState"),g),a(g,"closeComposer",[f],Object.getOwnPropertyDescriptor(g,"closeComposer"),g),g))}),define("discourse/plugins/discourse-presence/discourse/components/topic-presence-display",["exports","@ember/component","@ember/object/computed","@ember/service","discourse-common/utils/decorators","discourse/plugins/discourse-presence/discourse/lib/presence"],function(e,s,t,r,i,n){"use strict";function c(t,r,e,s,i){var n={};return Object.keys(s).forEach(function(e){n[e]=s[e]}),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=e.slice().reverse().reduce(function(e,s){return s(t,r,e)||e},n),i&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(i):void 0,n.initializer=void 0),void 0===n.initializer&&(Object.defineProperty(t,r,n),n=null),n}var o,a,l,u;Object.defineProperty(e,"__esModule",{value:!0}),e.default=s.default.extend((o=(0,i.default)("topic.id"),a=(0,i.on)("didInsertElement"),l=(0,i.on)("willDestroyElement"),c(u={topic:null,presenceManager:(0,r.inject)(),users:function(e){return this.presenceManager.users(e)},shouldDisplay:(0,t.gt)("users.length",0),subscribe:function(){this.presenceManager.subscribe(this.get("topic.id"),n.TOPIC_TYPE)},_destroyed:function(){this.presenceManager.unsubscribe(this.get("topic.id"),n.TOPIC_TYPE)}},"users",[o],Object.getOwnPropertyDescriptor(u,"users"),u),c(u,"subscribe",[a],Object.getOwnPropertyDescriptor(u,"subscribe"),u),c(u,"_destroyed",[l],Object.getOwnPropertyDescriptor(u,"_destroyed"),u),u))});
//# sourceMappingURL=/assets/plugins/discourse-presence-5057fd5e1dddaec14e66665360ed96b444dda09a3ca76490587d250a9bfdf382.js.map